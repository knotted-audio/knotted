{"version":3,"sources":["components/Waveform.worker.js","worker.js","components/Waveform.js","actions/loop.js","actions/grid.js","components/LoopPanel.js","components/GridPanel.js","audioUtils.js","components/Controls.js","App.js","reducers/loopReducer.js","reducers/gridReducer.js","middlewares/midiListener.js","reducers/rootReducer.js","middlewares/audioScheduler.js","middlewares/visualScheduler.js","engines/kick.js","engines/snare.js","engines/hat.js","engines/clap.js","engines/cymbal.js","serviceWorker.js","index.js","store.js"],"names":["addMethods","methods","module","exports","w","Worker","name","Waveform","props","buffer","width","height","zoom","color","onDone","pixelRatio","window","devicePixelRatio","canvas","useRef","worker","useLayoutEffect","middle","data","getChannelData","step","Math","ceil","length","offscreenCanvas","current","transferControlToOffscreen","postMessage","type","payload","fillStyle","onmessage","event","dw","floor","dh","style","ref","memo","prevProps","nextProps","id","createLoop","randomColor","uuidv4","TOGGLE_PLAY","togglePlay","setLoopLength","loopLength","triggerNote","note","velocity","triggerTime","loopStartTime","Loop","index","active","tempo","setActiveLoopA","beatDuration","lengthInBeats","round","duration","useDrag","item","opacity","drag","className","paddingTop","onClick","connect","state","loops","loop","activeLoop","grid","dispatch","createLoopA","loopId","setActiveLoop","map","l","key","GridLoopMarker","soft","numMarkers","backgroundColor","Grid","beat","loopTriggers","barBeat","loopTails","setGridElemA","addLoopInstanceA","drop","useDrop","accept","instanceId","activeLoops","g","originLoop","find","range","flat","filter","start","end","val","domElem","setGridElem","addLoopInstance","beats","beatsPerBar","workerInstance","audioCtx","getAudioCtx","AudioContext","latencyHint","recordRawInputStream","stream","endTime","recorder","MediaRecorder","Promise","resolve","ondataavailable","evt","currentTime","stop","then","d","arrayBuffer","err","decodeAudioData","result","sumAudio","reduce","sum","sample","abs","runLatencyTest","a","osc","createOscillator","frequency","value","destination","cTime","recordedBufferP","recordedBufferRes","recordedBuffer","sampleRate","recordingOffset","firstSecondOfAudio","slice","averageAudioValue","referenceDecibel","log10","threshold","pow","latency","i","localStorage","setItem","playing","metronome","gain","mediaStream","inputDeviceList","midiDeviceList","activeInputDevice","togglePlayA","toggleMetronomeA","setTempoA","setTempo","setGainA","setGain","setInputDevicesA","devices","setInputDevices","setMidiDevicesA","setMidiDevices","setMediaStreamA","setMediaStream","setLoopLengthA","useEffect","deviceId","navigator","mediaDevices","getUserMedia","audio","AUDIO_CONFIG","echoCancellation","noiseSuppression","autoGainControl","initDevices","midi","midiIn","inputs","values","input","next","done","push","requestMIDIAccess","addEventListener","target","console","log","enumerateDevices","res","deviceOpts","acc","dev","kind","label","midiDeviceOpts","theme","onChange","play","Comp","min","max","options","isClient","getSize","useCallback","innerWidth","undefined","innerHeight","useState","windowSize","setWindowSize","handleResize","removeEventListener","useWindowSize","gridWidth","isTestingLatency","setIsTestingLatency","onRunLatencyTest","getItem","DndProvider","backend","Backend","activeBeat","href","initialState","loopsInUse","activeMidiTrack","loopDuration","midiTracks","Array","keys","muted","timeline","gridElems","recordingMidi","quantizationBeats","quantizationMidi","activeMidiDevice","combineReducers","action","engine","secondsIntoLoop","timesliceInTrack","createdAt","Date","now","other","oldest","indexOfOldest","indexOf","indexOfOldestUnused","gridItem","audioScheduler","store","nextNoteTime","nextBeat","frame","getState","secondsPerBeat","forEach","source","createBufferSource","gainNode","createGain","setValueAtTime","triggerLoopsAtBeat","tracks","quantization","nextBeatTime","times","Object","loopNum","t","tShifted","parseFloat","time","ctx","engines","offsetAsFraction","tQuantized","trigger","triggerMidi","recordingLength","LATENCY_MS","outputAudioBuffer","createBuffer","inB","sliceBuffer","outB","copyFromChannel","recordInputStream","b","triggerMetronome","setTimeout","setLoopStartTime","clearTimeout","visualScheduler","nextGridChangeTime","nextGridBeat","prevBeat","classList","remove","add","requestAnimationFrame","elem","cancelAnimationFrame","Kick","setTone","tone","setVolume","vol","volume","setFXAmount","amount","fxAmount","this","decay","x","k","curve","Float32Array","deg","PI","distortion","createWaveShaper","makeDistortionCurve","setup","linearRampToValueAtTime","exponentialRampToValueAtTime","Snare","noise","noiseBuffer","noiseFilter","createBiquadFilter","noiseEnvelope","oscEnvelope","bufferSize","output","random","HiHat","ratios","bndPass","Q","hipass","panner","createStereoPanner","pan","cos","ratio","Clap","envelope","pulseWidth","feedback","echo","createDelay","Cymbal","KEY_TO_NOTE","NOTE_TO_KEY","number2key","n","midiListener","listeningTo","msg","cmd","listen","schedule","recordMidiNote","newAction","C1","D1","E1","F1","C2","Db2","D2","Eb2","E2","actionResult","Boolean","location","hostname","match","ReactDOM","render","StrictMode","createStore","rootReducer","applyMiddleware","configureStore","document","getElementById","serviceWorker","ready","registration","unregister","catch","error","message"],"mappings":"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","file":"static/js/main.295ef9cb.chunk.js","sourcesContent":["\n\t\t\t\tvar addMethods = require(\"../../node_modules/workerize-loader/dist/rpc-wrapper.js\")\n\t\t\t\tvar methods = [\"draw\"]\n\t\t\t\tmodule.exports = function() {\n\t\t\t\t\tvar w = new Worker(__webpack_public_path__ + \"68a85f8416c7075e19df.worker.js\", { name: \"[hash].worker.js\" })\n\t\t\t\t\taddMethods(w, methods)\n\t\t\t\t\t\n\t\t\t\t\treturn w\n\t\t\t\t}\n\t\t\t","\n\t\t\t\tvar addMethods = require(\"../node_modules/workerize-loader/dist/rpc-wrapper.js\")\n\t\t\t\tvar methods = [\"sliceBuffer\"]\n\t\t\t\tmodule.exports = function() {\n\t\t\t\t\tvar w = new Worker(__webpack_public_path__ + \"0936f4e41e22ec92ee4e.worker.js\", { name: \"[hash].worker.js\" })\n\t\t\t\t\taddMethods(w, methods)\n\t\t\t\t\t\n\t\t\t\t\treturn w\n\t\t\t\t}\n\t\t\t","//\n// Use offscreen canvas and web worker to do the canvas rendering on a\n// worker thread\n//\n// http://shimi.io/blog/offscreen-canvas-react-three-js-web-workers\n//\nimport React, { useRef, useLayoutEffect, memo } from \"react\";\n\n/* eslint import/no-webpack-loader-syntax: off */\nimport Worker from \"workerize-loader!./Waveform.worker\";\n\nconst Waveform = (props = {}) => {\n  const {\n    buffer = null,\n    width = 500,\n    height = 100,\n    zoom = 1,\n    color = \"black\",\n    onDone = null,\n    pixelRatio = window.devicePixelRatio,\n  } = props;\n\n  const canvas = useRef(null);\n  const worker = new Worker();\n\n  useLayoutEffect(() => {\n    const w = width * zoom;\n    const middle = height / 2.0;\n\n    const data = buffer.getChannelData(0);\n    const step = Math.ceil(data.length / w);\n\n    // Creating an OffscreenCanvas element.\n    // Rendering changes in this object will be reflected\n    // and displayed on the original canvas.\n    const offscreenCanvas = canvas.current.transferControlToOffscreen();\n\n    // worker.postMessage is a method which\n    // sends a message to the worker's inner scope.\n    worker.postMessage(\n      {\n        type: \"waveform-render\",\n        payload: {\n          canvas: offscreenCanvas,\n          width,\n          step,\n          middle,\n          data,\n          fillStyle: color,\n        },\n      },\n      [offscreenCanvas]\n    );\n\n    if (onDone) {\n      // worker.onmessage event will be invoked by the worker\n      // whenever the rendering process is done.\n      worker.onmessage = (event) => {\n        if (event.data.type === \"waveform-rendered\") {\n          onDone();\n        }\n      };\n      onDone();\n    }\n  });\n\n  const dw = Math.floor(pixelRatio * width * zoom);\n  const dh = Math.floor(pixelRatio * height);\n  const style = { width: width * zoom, height };\n  return <canvas ref={canvas} width={dw} height={dh} style={style} />;\n};\n\n// Use the loop ID equality as a proxy for the buffer equality\nexport default memo(\n  (props) => <Waveform {...props} />,\n  (prevProps, nextProps) =>\n    prevProps.id === nextProps.id &&\n    prevProps.width === nextProps.width &&\n    prevProps.height === nextProps.height &&\n    prevProps.color === nextProps.color\n);\n","import { v4 as uuidv4 } from \"uuid\";\nimport randomColor from \"randomcolor\";\nexport const CREATE_LOOP = \"@GRID/CREATE_LOOP\";\nexport const RECORD_MIDI_NOTE = \"@GRID/RECORD_MIDI_NOTE\";\nexport const SET_LOOP_START_TIME = \"@GRID/SET_LOOP_START_TIME\";\n\nexport const createLoop = (buffer) => ({\n  type: CREATE_LOOP,\n  payload: {\n    buffer,\n    color: randomColor(),\n    id: uuidv4(),\n  },\n});\n\nexport const setLoopStartTime = (loopStartTime, loopDuration) => ({\n  type: SET_LOOP_START_TIME,\n  payload: {\n    loopStartTime,\n    loopDuration\n  },\n});\n\nexport const recordMidiNote = (engine, triggerTime) => ({\n  type: RECORD_MIDI_NOTE,\n  payload: {\n    engine,\n    triggerTime,\n  },\n});\n","import { v4 as uuidv4 } from \"uuid\";\n\nexport const TOGGLE_PLAY = '@GRID/TOGGLE_PLAY';\nexport const TOGGLE_METRONOME = '@GRID/TOGGLE_METRONOME';\nexport const SET_TEMPO = '@GRID/SET_TEMPO';\nexport const SET_GAIN = '@GRID/SET_GAIN';\nexport const SET_ACTIVE_LOOP = '@GRID/SET_ACTIVE_LOOP';\nexport const SET_INPUT_DEVICES = '@GRID/SET_INPUT_DEVICES';\nexport const SET_MIDI_DEVICES = '@GRID/SET_MIDI_DEVICES';\nexport const SET_LOOP_LENGTH = '@GRID/SET_LOOP_LENGTH';\nexport const SET_MEDIA_STREAM = '@GRID/SET_MEDIA_STREAM';\nexport const SET_GRID_ELEM = '@GRID/SET_GRID_ELEM';\nexport const ADD_LOOP_INSTANCE = '@GRID/ADD_LOOP_INSTANCE';\nexport const TRIGGER_NOTE = '@GRID/TRIGGER_NOTE';\n\nexport const addLoopInstance = (beat, loopId) => ({\n  type: ADD_LOOP_INSTANCE,\n  payload: { beat, loopId, instanceId: uuidv4() }\n});\nexport const togglePlay = () => ({\n  type: TOGGLE_PLAY,\n});\nexport const toggleMetronome = () => ({\n  type: TOGGLE_METRONOME,\n});\nexport const setActiveLoop = (loopId) => ({\n  type: SET_ACTIVE_LOOP,\n  payload: { loopId }\n});\nexport const setLoopLength = (loopLength) => ({\n  type: SET_LOOP_LENGTH,\n  payload: { loopLength }\n});\nexport const setGain = (gain) => ({\n  type: SET_GAIN,\n  payload: { gain }\n});\nexport const setInputDevices = (devices) => ({\n  type: SET_INPUT_DEVICES,\n  payload: { devices }\n});\nexport const setMidiDevices = (devices) => ({\n  type: SET_MIDI_DEVICES,\n  payload: { devices }\n});\nexport const setMediaStream = (stream) => ({\n  type: SET_MEDIA_STREAM,\n  payload: { stream }\n});\nexport const setTempo = (tempo) => ({\n  type: SET_TEMPO,\n  payload: { tempo }\n});\nexport const setGridElem = (index, domElem) => ({\n  type: SET_GRID_ELEM,\n  payload: { index, domElem }\n});\nexport const triggerNote = (note, velocity, triggerTime, loopStartTime) => ({\n  type: TRIGGER_NOTE,\n  payload: { note, velocity, triggerTime, loopStartTime }\n});\n","import React, { useEffect } from \"react\";\nimport { useDrag } from \"react-dnd\";\nimport { connect } from \"react-redux\";\n\nimport Waveform from \"./Waveform\";\n\nimport { createLoop } from \"../actions/loop\";\nimport { setActiveLoop } from \"../actions/grid\";\n\n// var audioCtx = new (window.AudioContext || window.webkitAudioContext)();\n// function getData() {\n//   const request = new XMLHttpRequest();\n//   request.open(\"GET\", \"Amen-break.mp3\", true);\n//   request.responseType = \"arraybuffer\";\n//\n//   return new Promise((resolve, reject) => {\n//     request.onload = function () {\n//       const audioData = request.response;\n//\n//       audioCtx.decodeAudioData(\n//         audioData,\n//         function (buffer) {\n//           resolve(buffer);\n//         },\n//         function (e) {\n//           reject(\"Error with decoding audio data\" + e.err);\n//         }\n//       );\n//     };\n//\n//     request.send();\n//   });\n// }\n\nfunction Loop({\n  id,\n  index,\n  length,\n  active,\n  color,\n  buffer,\n  width,\n  height,\n  tempo,\n  setActiveLoopA,\n}) {\n  const beatDuration = 60.0 / tempo;\n  const lengthInBeats = Math.round(buffer.duration / beatDuration);\n\n  // Allow loops to be dragged onto the grid\n  const [{ opacity }, drag] = useDrag({\n    item: { id, type: 'LOOP' },\n  });\n\n  return (\n    <div\n      ref={drag}\n      className={`Loop ${active ? \"active\" : \"\"}`}\n      style={{ opacity, height, width, paddingTop: 20 }}\n      onClick={() => setActiveLoopA(id)}\n    >\n      <Waveform\n        id={id}\n        width={width}\n        height={height - 20}\n        color={color}\n        buffer={buffer}\n      />\n      <div>Loop {index} {'//'} {lengthInBeats} beats</div>\n    </div>\n  );\n}\n\nfunction LoopPanel({ loops, width, tempo, activeLoop, createLoopA, setActiveLoopA }) {\n  const height = 75;\n\n  // useEffect(() => {\n  //   getData().then((buffer) => createLoopA(buffer));\n  // }, [createLoopA]);\n\n  return (\n    <div className=\"LoopPanel\" style={{ width }}>\n      {loops.map((l, index) => (\n        <Loop\n          key={l.id}\n          index={index}\n          setActiveLoopA={setActiveLoopA}\n          active={activeLoop === l.id}\n          {...l}\n          tempo={tempo}\n          width={width - 20}\n          height={height}\n        />\n      ))}\n    </div>\n  );\n}\n\nconst mapStateToProps = (state) => ({\n  loops: state.loop.loops,\n  activeLoop: state.grid.activeLoop,\n  tempo: state.grid.tempo,\n});\nconst mapDispatchToProps = (dispatch) => ({\n  createLoopA: (buffer) => dispatch(createLoop(buffer)),\n  setActiveLoopA: (loopId) => dispatch(setActiveLoop(loopId)),\n});\n\nexport default connect(mapStateToProps, mapDispatchToProps)(LoopPanel);\n","import React from \"react\";\nimport { connect } from \"react-redux\";\nimport { useDrop } from \"react-dnd\";\n\nimport { setGridElem, addLoopInstance } from \"../actions/grid\";\n\nfunction GridLoopMarker({ id, color, soft, numMarkers }) {\n  const opacity = soft ? 0.3 : 1;\n  return (\n    <div\n      className={`GridLoopMarker ${numMarkers > 4 ? 'half' : ''}`}\n      style={{ backgroundColor: color, opacity }}\n    />\n  );\n}\n\nfunction Grid({\n  beat,\n  barBeat,\n  loopTriggers,\n  loopTails,\n  activeLoop,\n  setGridElemA,\n  addLoopInstanceA,\n  onClick,\n}) {\n\n  // Add loop instances when they are dragged onto the grid\n  const drop = useDrop({\n    accept: ['LOOP'],\n    drop: (item) => addLoopInstanceA(beat, item.id)\n  })[1];\n\n  const numMarkers = loopTriggers.length + loopTails.length;\n\n  // Save a ref (into redux) so the scheduler can manipule the \"active\" class to\n  // animate the sequencer\n  return (\n    <div\n      ref={(ref) => {\n        setGridElemA(beat, ref);\n        drop(ref);\n      }}\n      className=\"Grid\"\n      onClick={onClick}\n    >\n      {loopTriggers.map((l) => (\n        <GridLoopMarker key={l.instanceId} {...l} numMarkers={numMarkers} />\n      ))}\n      {loopTails.map((l) => (\n        <GridLoopMarker key={l.instanceId} {...l} soft={true} numMarkers={numMarkers} />\n      ))}\n    </div>\n  );\n}\n\nfunction GridPanel({\n  activeLoop,\n  width,\n  grid,\n  beats,\n  beatsPerBar,\n  setGridElemA,\n  addLoopInstanceA,\n}) {\n  return (\n    <div className=\"GridPanel\" style={{ width, height: width }}>\n      {grid.map((g) => (\n        <Grid\n          key={g.beat}\n          {...g}\n          setGridElemA={setGridElemA}\n          addLoopInstanceA={addLoopInstanceA}\n          onClick={() => activeLoop && addLoopInstanceA(g.beat, activeLoop)}\n        />\n      ))}\n    </div>\n  );\n}\n\nconst inRange = (start, end, val) => val >= start && val <= end;\n\nconst mapStateToProps = (state) => {\n  const tempo = state.grid.tempo;\n\n  const activeLoops = state.grid.grid\n    .map((g) =>\n      g.loopTriggers.map(({ id, instanceId }) => {\n        const originLoop = state.loop.loops.find((l) => l.id === id);\n        const beatDuration = 60.0 / tempo;\n        const lengthInBeats = Math.round(originLoop.buffer.duration / beatDuration);\n\n        const range = [\n          g.beat,\n          (g.beat + lengthInBeats - 1) % state.grid.grid.length,\n        ];\n\n        return {\n          range,\n          instanceId,\n          ...originLoop,\n        };\n      })\n    )\n    .flat();\n\n  const grid = state.grid.grid.map((g) => {\n    const loopTriggers = activeLoops.filter((l) => l.range[0] === g.beat);\n    const loopTails = activeLoops.filter((l) =>\n      inRange(l.range[0] + 1, l.range[1], g.beat) ||\n      (l.range[0] > l.range[1] && g.beat > l.range[0]) ||\n      (l.range[0] > l.range[1] && g.beat < l.range[1])\n    );\n\n    return {\n      ...g,\n      loopTriggers,\n      loopTails,\n    };\n  });\n\n  return {\n    ...state.grid,\n    grid,\n  };\n};\n\nconst mapDispatchToProps = (dispatch) => ({\n  setGridElemA: (index, domElem) => dispatch(setGridElem(index, domElem)),\n  addLoopInstanceA: (beat, loopId) => dispatch(addLoopInstance(beat, loopId)),\n});\n\nexport default connect(mapStateToProps, mapDispatchToProps)(GridPanel);\n","/* eslint import/no-webpack-loader-syntax: off */\nimport worker from \"workerize-loader!./worker\";\nconst workerInstance = new worker();\n\nconst SCHEDULE_AHEAD_TIME = 0.1;\nconst BLIP_LENGTH = 0.01;\n\n//\n// Global value set by the latency test.\n//\nlet audioCtx = null;\nexport function getAudioCtx() {\n  if (audioCtx) return audioCtx;\n\n  audioCtx = new AudioContext({ latencyHint: 0 });\n  return audioCtx;\n}\n\nexport function getDeviceStream(deviceId) {\n  const AUDIO_CONFIG = {\n    echoCancellation: false,\n    noiseSuppression: false,\n    autoGainControl: false,\n    latency: 0,\n  };\n  return navigator.mediaDevices.getUserMedia({\n    audio: { AUDIO_CONFIG, deviceId },\n  });\n}\n\nexport function triggerMidi(\n  tracks,\n  beats,\n  secondsPerBeat,\n  quantization,\n  nextBeat,\n  nextBeatTime,\n  loopDuration,\n  loopStartTime\n) {\n  for (let i = 0; i < tracks.length; i++) {\n    const { muted, timeline } = tracks[i];\n\n    const times = Object.keys(timeline);\n    if (muted || times.length === 0) {\n      continue;\n    }\n\n    const loopNum = Math.floor((nextBeatTime - loopStartTime) / loopDuration);\n    // console.log(loopNum, loopDuration);\n\n    times\n      .filter((t) => {\n        // Shift the trigger time to the current audio context time (relative to the\n        // start of the loop)\n        const tShifted = parseFloat(t) + loopStartTime + loopDuration * loopNum;\n\n        // Schedule notes 1 beat ahead\n        return (\n          tShifted > nextBeatTime + secondsPerBeat &&\n          tShifted <= nextBeatTime + secondsPerBeat * 2\n        );\n      })\n      .forEach((time) => {\n        const ctx = getAudioCtx();\n        // Preconfigured sounds to play\n        const engines = timeline[time];\n\n        // Shift the time to be relative to this loop\n        const tShifted = parseFloat(time) + loopStartTime + loopDuration * loopNum;\n\n        // Quantize the notes so they are in time with the click\n        //\n        // TODO: Generalise to be configurable to different quantization settings\n        const offsetFromBeat = (nextBeatTime + secondsPerBeat) - tShifted;\n        const offsetAsFraction = offsetFromBeat / secondsPerBeat;\n        let tQuantized = nextBeatTime + secondsPerBeat;\n        if (offsetAsFraction < 0.125) {\n        } else if (offsetAsFraction < (3/8)) {\n          tQuantized += 0.25 * secondsPerBeat;\n        } else if (offsetAsFraction < (5/8)) {\n          tQuantized += 0.5 * secondsPerBeat;\n        } else if (offsetAsFraction < (7/8)) {\n          tQuantized += 0.75 * secondsPerBeat;\n        } else {\n          tQuantized += 1 * secondsPerBeat;\n        }\n\n        engines.forEach((engine) => {\n          const instance = new engine(ctx);\n          instance.trigger(tQuantized);\n        });\n      });\n  }\n}\n\nexport function triggerMetronome(\n  audioCtx,\n  b,\n  nextBeatTime,\n  beats,\n  beatsPerBar\n) {\n  const osc = audioCtx.createOscillator();\n  osc.connect(audioCtx.destination);\n\n  if (b % beats === 0) {\n    osc.frequency.value = 880.0;\n  } else if (b % beatsPerBar === 0) {\n    osc.frequency.value = 440.0;\n  } else {\n    osc.frequency.value = 220.0;\n  }\n\n  osc.start(nextBeatTime);\n  osc.stop(nextBeatTime + BLIP_LENGTH);\n}\n\nexport function triggerLoopsAtBeat(\n  grid,\n  loops,\n  nextBeat,\n  beats,\n  audioCtx,\n  gain,\n  nextNoteTime\n) {\n  const { loopTriggers } = grid[nextBeat % beats];\n\n  loopTriggers\n    .map(({ id }) => loops.find((l) => l.id === id))\n    .forEach(({ buffer }) => {\n      const source = audioCtx.createBufferSource();\n\n      // set the buffer in the AudioBufferSourceNode\n      source.buffer = buffer;\n\n      // TODO: Find a better place to apply global gain\n      // start the source playing\n      const gainNode = audioCtx.createGain();\n      gainNode.gain.setValueAtTime(gain, audioCtx.currentTime);\n      source.connect(gainNode).connect(audioCtx.destination);\n      source.start(nextNoteTime);\n    });\n}\n\nfunction recordRawInputStream(stream, audioCtx, duration) {\n  const recorder = new MediaRecorder(stream);\n  recorder.start(duration * 1000);\n  let endTime;\n  return new Promise(\n    (resolve) =>\n      (recorder.ondataavailable = (evt) => {\n        endTime = audioCtx.currentTime;\n\n        if (recorder.state === \"recording\") {\n          recorder.stop();\n        }\n        resolve(evt.data);\n      })\n  )\n    .then((d) => d.arrayBuffer())\n    .then(\n      (d) =>\n        new Promise((resolve, err) =>\n          audioCtx.decodeAudioData(\n            d,\n            (result) => resolve([result, endTime]),\n            err\n          )\n        )\n    );\n}\n\nexport function recordInputStream(stream, audioCtx, start, end) {\n  // This should record the full loop with a small gap at the start and end\n  const secondsUntilEnd = end - audioCtx.currentTime;\n  const recordingLength = secondsUntilEnd + 2 * SCHEDULE_AHEAD_TIME;\n  const LATENCY_MS = window.localStorage.getItem(\"Knotted-Latency\");\n\n  return recordRawInputStream(stream, audioCtx, recordingLength).then(\n    async ([d, endTime]) => {\n      // Calculate the difference in requested and recorded durations\n      // const durOffset = d.duration - recordingLength;\n      // const durOffset = -0.180;\n      // console.log(durOffset);\n\n      const sampleRate = d.sampleRate;\n      const outputAudioBuffer = audioCtx.createBuffer(\n        1,\n        (end - start) * sampleRate,\n        sampleRate\n      );\n\n      const inB = d.getChannelData(0);\n      // const outB = outputAudioBuffer.getChannelData(0);\n      // for (let t = 0; t < (end - start) * sampleRate; t++) {\n      //   outB[t] = inB[t + Math.floor((LATENCY_MS * sampleRate) / 1000)];\n      // }\n\n      // Offset the recording by the global system latency value\n      // Do the processing in a web-worker to avoid locking the event loop\n      const outB = await workerInstance.sliceBuffer(\n        inB,\n        end - start,\n        sampleRate,\n        LATENCY_MS\n      );\n      outputAudioBuffer.copyFromChannel(outB, 0);\n\n      return outputAudioBuffer;\n    }\n  );\n}\n\nfunction sumAudio(buffer) {\n  return buffer.reduce((sum, sample) => sum + Math.abs(sample), 0);\n}\n\n/**\n * Play a sine wave and record the delay in hearing it\n *\n * Adapted from:\n *\n *   https://github.com/superpoweredSDK/WebBrowserAudioLatencyMeasurement\n */\nexport async function runLatencyTest(stream) {\n  const audioCtx = getAudioCtx();\n  const osc = audioCtx.createOscillator();\n  osc.frequency.value = 440.0;\n  osc.connect(audioCtx.destination);\n\n  const cTime = audioCtx.currentTime;\n\n  // Sequence of events:\n  //\n  //  - 2 seconds of silence (cTime + 2)\n  //  - 1 second of 440hz sine wave (cTime + 3)\n  //  - finish recording and sine wave (cTime + 4)\n  const recordedBufferP = recordRawInputStream(stream, audioCtx, 4);\n  osc.start(cTime + 2);\n  osc.stop(cTime + 3);\n\n  // Wait for the recording to finish\n  const [recordedBufferRes, endTime] = await recordedBufferP;\n  const recordedBuffer = recordedBufferRes.getChannelData(0);\n\n  // Now we have a buffer with roughly 1 second of sound louder than the rest. We\n  // want to isolate that and determine its timestamp then compare that to when it\n  // should have been recorded (cTime + 2 -> cTime + 3). The difference will be the\n  // recording latency\n\n  const { sampleRate } = recordedBufferRes;\n  // The recording takes a small amount of time to start, so the timing in the buffer\n  // is shifted slightly later. I'm still not sure how to apply this. We will need to\n  // account for this in our loop slicing somehow.\n  const recordingOffset = (endTime - 4) * 1000;\n\n  // Calculate the baseline audio amplitude during the \"silence period\", then\n  // take an audio energy rise of 24 decibels to be the threshold for identifying\n  // the start of the oscillator starting\n  const firstSecondOfAudio = recordedBuffer.slice(0, sampleRate);\n  const averageAudioValue = sumAudio(firstSecondOfAudio) / sampleRate;\n  const referenceDecibel = 20.0 * Math.log10(averageAudioValue) + 24.0;\n  const threshold = Math.pow(10.0, referenceDecibel / 20.0);\n\n  let latency = null;\n  // Look from (cTime + 1) to (cTime + 4) for the start of the oscillator pulse\n  for (let i = sampleRate; i < sampleRate * 4; i++) {\n    if (recordedBuffer[i] > Math.abs(threshold)) {\n      latency = Math.round(Math.abs(2000 - (i * 1000) / sampleRate));\n      break;\n    }\n  }\n\n  window.localStorage.setItem(\"Knotted-Latency\", latency);\n  window.localStorage.setItem(\"Knotted-RecordingOffset\", recordingOffset);\n\n  return latency;\n}\n\nexport async function loadSound(ctx, url) {\n  const response = await fetch(url);\n  const rawBuffer = await response.arrayBuffer();\n  return await ctx.decodeAudioData(rawBuffer);\n}\n","import React, { useEffect } from \"react\";\nimport { connect } from \"react-redux\";\n\nimport ReactControlPanel, {\n  Select,\n  Range,\n  Checkbox,\n  Custom,\n} from \"react-control-panel\";\n\nimport {\n  setTempo,\n  togglePlay,\n  toggleMetronome,\n  setLoopLength,\n  setGain,\n  setInputDevices,\n  setMediaStream,\n  setMidiDevices,\n} from \"../actions/grid\";\nimport { getDeviceStream } from \"../audioUtils\";\n\nfunction Controls({\n  playing,\n  loopLength,\n  gain,\n  width,\n  tempo,\n  metronome,\n  mediaStream,\n  midiDeviceList,\n  activeInputDevice,\n  inputDeviceList,\n\n  togglePlayA,\n  setGainA,\n  setTempoA,\n  toggleMetronomeA,\n  setInputDevicesA,\n  setMidiDevicesA,\n  setMediaStreamA,\n  setLoopLengthA,\n}) {\n  //\n  // Get permission to access input audio stream\n  //\n  useEffect(() => {\n    getDeviceStream(activeInputDevice)\n      .then((stream) => setMediaStreamA(stream));\n  }, [setMediaStreamA, activeInputDevice]);\n\n  useEffect(() => {\n    // https://glitch.com/~webmidi-examples\n    // Reset.\n    function initDevices(midi) {\n      const midiIn = [];\n      const inputs = midi.inputs.values();\n      for (\n        let input = inputs.next();\n        input && !input.done;\n        input = inputs.next()\n      ) {\n        midiIn.push(input.value);\n      }\n\n      setMidiDevicesA(midiIn);\n    }\n\n    navigator.requestMIDIAccess().then(\n      (midi) => {\n        // Also react to device changes.\n        midi.addEventListener(\"statechange\", (event) =>\n          initDevices(event.target)\n        );\n        initDevices(midi);\n      },\n      (err) => console.log(\"Something went wrong\", err)\n    );\n  }, [setMidiDevicesA]);\n\n  // When we have permission to access the WebAudio API, get the list of connected devices\n  useEffect(() => {\n    if (mediaStream) {\n      navigator.mediaDevices\n        .enumerateDevices()\n        .then((res) => setInputDevicesA(res));\n    }\n  }, [mediaStream, setInputDevicesA]);\n\n  const deviceOpts = inputDeviceList.reduce((acc, dev) => {\n    if (dev.kind === \"audioinput\") {\n      acc[dev.label] = dev.deviceId;\n    }\n    return acc;\n  }, {});\n\n  const midiDeviceOpts = midiDeviceList.reduce((acc, dev) => {\n    if (dev.type === \"input\") {\n      acc[dev.name] = dev.id;\n    }\n    return acc;\n  }, {});\n\n  return (\n    <ReactControlPanel\n      theme=\"light\"\n      width={width * 0.6}\n      onChange={(key, val) => {\n        if (key === \"tempo\") {\n          setTempoA(val);\n        }\n        if (key === \"metronome\") {\n          toggleMetronomeA();\n        }\n        if (key === \"gain\") {\n          setGainA(val);\n        }\n        if (key === \"loop length\") {\n          if (val !== 12) {\n            setLoopLengthA(val);\n          }\n        }\n        if (key === \"play\") {\n          togglePlayA();\n        }\n      }}\n      state={{\n        latency: false,\n        tempo,\n        gain,\n        metronome,\n        \"loop length\": loopLength,\n        play: playing,\n      }}\n    >\n      <Custom label=\"play\" Comp={({ value, onChange }) =>\n          <button className={`PlayButton ${value ? 'pause' : ''}`} onClick={togglePlayA} />\n       } />\n      <Checkbox label=\"metronome\" />\n\n      <Range label=\"loop length\" min={4} max={16} step={4} />\n      <Range label=\"tempo\" min={40} max={260} step={1} />\n      <Range label=\"gain\" min={0} max={1} />\n\n      <Select label=\"input\" options={deviceOpts} />\n      <Select label=\"inputmidi\" options={midiDeviceOpts} />\n\n    </ReactControlPanel>\n  );\n}\n\nconst mapDispatchToProps = (dispatch) => ({\n  togglePlayA: () => dispatch(togglePlay()),\n  toggleMetronomeA: () => dispatch(toggleMetronome()),\n  setTempoA: (tempo) => dispatch(setTempo(tempo)),\n  setGainA: (gain) => dispatch(setGain(gain)),\n  setInputDevicesA: (devices) => dispatch(setInputDevices(devices)),\n  setMidiDevicesA: (devices) => dispatch(setMidiDevices(devices)),\n  setMediaStreamA: (stream) => dispatch(setMediaStream(stream)),\n  setLoopLengthA: (loopLength) => dispatch(setLoopLength(loopLength)),\n});\nconst mapStateToProps = (state) => ({\n  playing: state.grid.playing,\n  tempo: state.grid.tempo,\n  metronome: state.grid.metronome,\n  gain: state.grid.gain,\n  loopLength: state.grid.loopLength,\n  mediaStream: state.grid.mediaStream,\n  inputDeviceList: state.grid.inputDeviceList,\n  midiDeviceList: state.grid.midiDeviceList,\n  activeInputDevice: state.grid.activeInputDevice,\n});\n\nexport default connect(mapStateToProps, mapDispatchToProps)(Controls);\n","import React, { useEffect, useState, useCallback } from \"react\";\nimport { connect } from \"react-redux\";\nimport { DndProvider } from \"react-dnd\";\nimport Backend from \"react-dnd-html5-backend\";\n\nimport LoopPanel from \"./components/LoopPanel\";\nimport GridPanel from \"./components/GridPanel\";\nimport Controls from \"./components/Controls\";\nimport \"./App.css\";\n\nimport { togglePlay } from \"./actions/grid\";\nimport { runLatencyTest } from \"./audioUtils\";\n\nfunction useWindowSize() {\n  const isClient = typeof window === \"object\";\n\n  const getSize = useCallback(() => {\n    return {\n      width: isClient ? window.innerWidth : undefined,\n      height: isClient ? window.innerHeight : undefined,\n    };\n  }, [isClient]);\n\n  const [windowSize, setWindowSize] = useState(getSize);\n  useEffect(() => {\n    if (!isClient) {\n      return false;\n    }\n\n    function handleResize() {\n      setWindowSize(getSize());\n    }\n\n    window.addEventListener(\"resize\", handleResize);\n\n    return () => window.removeEventListener(\"resize\", handleResize);\n  }, [getSize, isClient]);\n\n  return windowSize;\n}\n\nfunction App({ playing, mediaStream, togglePlayA }) {\n  const { width, height } = useWindowSize();\n  const gridWidth = Math.min(0.75 * width, height - 120);\n\n  const [isTestingLatency, setIsTestingLatency] = useState(false);\n\n  const onRunLatencyTest = async () => {\n    if (playing) {\n      togglePlayA();\n    }\n    setIsTestingLatency(true);\n    await runLatencyTest(mediaStream);\n    setIsTestingLatency(false);\n  };\n\n  const latency = window.localStorage.getItem('Knotted-Latency');\n  return (\n    <div className=\"Wrapper\">\n      {isTestingLatency ? null : (\n        <header className=\"Controls\">\n          <h2>Knotted.live</h2>\n          <div>\n            <Controls width={Math.min(width, 650)} />\n          </div>\n          <button className=\"MainButton\" onClick={onRunLatencyTest}>Configure Latency ({latency} ms)</button>\n        </header>\n      )}\n      <div className=\"App\">\n        {isTestingLatency ? (\n          <h2>Testing... Please wait</h2>\n        ) : (\n          <DndProvider backend={Backend}>\n            <GridPanel width={gridWidth} activeBeat={0} />\n            <LoopPanel width={width - gridWidth} />\n          </DndProvider>\n        )}\n      </div>\n      <footer>\n        By <a href=\"https://jtfell.com\">jtfell</a>\n      </footer>\n    </div>\n  );\n}\n\nconst mapDispatchToProps = (dispatch) => ({\n  togglePlayA: () => dispatch(togglePlay()),\n});\nconst mapStateToProps = (state) => ({\n  playing: state.grid.playing,\n  mediaStream: state.grid.mediaStream,\n});\n\nexport default connect(mapStateToProps, mapDispatchToProps)(App);\n","import { CREATE_LOOP, RECORD_MIDI_NOTE, SET_LOOP_START_TIME } from \"../actions/loop\";\nimport { ADD_LOOP_INSTANCE } from \"../actions/grid\";\n\n// Loop: {\n//   id,\n//   createdAt,\n//   buffer\n// }\n\nconst initialState = {\n  loops: [],\n  loopsInUse: [],\n\n  activeMidiTrack: 0,\n  loopStartTime: 0,\n  loopDuration: 0,\n};\n\nconst MAX_LOOPS = 5;\nconst midiTracks = [...Array(MAX_LOOPS).keys()].map(() => ({ muted: false, timeline: {} }));\n\nexport function getMidiTracks() {\n  return midiTracks;\n}\n\nexport default (state = initialState, action) => {\n  switch (action.type) {\n    case RECORD_MIDI_NOTE: {\n      const { triggerTime, engine } = action.payload;\n      const { timeline } = midiTracks[state.activeMidiTrack];\n\n      // Determine the offset from the start of the loop it was recorded in. This allows us\n      // to replay it at the right time in subsequent loops and quantize it\n      const secondsIntoLoop = (triggerTime - state.loopStartTime) % state.loopDuration;\n\n      const timesliceInTrack = timeline[secondsIntoLoop] || [];\n      timesliceInTrack.push(engine);\n      timeline[secondsIntoLoop] = timesliceInTrack;\n      \n      // Don't actually change the redux state\n      return {\n        ...state,\n      }\n    }\n\n    case SET_LOOP_START_TIME: {\n      return {\n        ...state,\n        loopStartTime: action.payload.loopStartTime,\n        loopDuration: action.payload.loopDuration,\n      }\n    }\n\n    case CREATE_LOOP: {\n      let loops = [...state.loops];\n\n      const createdAt = Date.now();\n      if (loops.length < MAX_LOOPS) {\n        loops = [...loops, { ...action.payload, createdAt }];\n        return {\n          ...state,\n          loops,\n        };\n      }\n\n      //\n      // We want the following properties:\n      //\n      //  - index of each loop remains stable\n      //  - list of loops is bounded (for screen space and memory reasons)\n      //  - the oldest loop is the one removed first\n      //  - loops used on the grid cant be removed\n      //\n      const [oldestUnused, indexOfOldestUnused] = loops.reduce(\n        ([oldest, indexOfOldest], other, index) => {\n          // Early return if the loop is used on the grid\n          const inUse = state.loopsInUse.indexOf(other.id) > -1;\n          if (inUse) {\n            return [oldest, indexOfOldest];\n          }\n\n          // If there is no other candidate, return the loop\n          if (oldest === null) {\n            return [other, index];\n          }\n\n          // If oldest is newer than the candidate, return the candidate\n          if (oldest.createdAt > other.createdAt) {\n            return [other, index];\n          }\n\n          return [oldest, indexOfOldest];\n        },\n        [null, -1]\n      );\n\n      if (indexOfOldestUnused > -1) {\n        loops[indexOfOldestUnused] = { ...action.payload, createdAt };\n      } else {\n        console.log(\"No space!\");\n        // Alert the user there is no space in the buffer somehow?\n      }\n\n      return {\n        ...state,\n        loops,\n      };\n    }\n    case ADD_LOOP_INSTANCE: {\n      return {\n        ...state,\n        loopsInUse: [...state.loopsInUse, action.payload.loopId],\n      };\n    }\n    default:\n      return state;\n  }\n};\n","import {\n  TOGGLE_PLAY,\n  TOGGLE_METRONOME,\n  SET_ACTIVE_LOOP,\n  SET_GAIN,\n  SET_TEMPO,\n  SET_LOOP_LENGTH,\n  SET_INPUT_DEVICES,\n  SET_MIDI_DEVICES,\n  SET_MEDIA_STREAM,\n  SET_GRID_ELEM,\n  ADD_LOOP_INSTANCE,\n} from \"../actions/grid\";\n\nwindow.gridElems = [];\n\nconst initialState = {\n  beatsPerBar: 4,\n  beats: 16,\n  playing: false,\n  recordingMidi: true,\n  metronome: true,\n  tempo: 136.55,\n  loopLength: 8,\n  quantizationBeats: 4,\n  quantizationMidi: 0.25, // quarter note\n  gain: 0.2,\n\n  // The highlighted loop that will be added to the grid when its clicked\n  activeLoop: null,\n\n  activeMidiDevice: null,\n  midiDeviceList: [],\n\n  activeInputDevice: null,\n  inputDeviceList: [],\n  mediaStream: null,\n\n  grid: generateGrid(16, 4),\n};\n\n// TODO: Seemless switching betweeen resolutions - different state per view\n\nfunction generateGrid(beats, beatsPerBar) {\n  return [...Array(beats).keys()].map((beat) => {\n    const barBeat = (beat + 1) % beatsPerBar;\n\n    return {\n      beat: beat + 1,\n      barBeat,\n      loopTriggers: [],\n    };\n  });\n}\n\nexport default (state = initialState, action) => {\n  switch (action.type) {\n    case SET_GRID_ELEM:\n      // Mutate in place as these are opaque refs\n      window.gridElems[action.payload.index - 1] = action.payload.domElem;\n      return state;\n    case ADD_LOOP_INSTANCE:\n      const grid = [...state.grid];\n      const gridItem = grid[action.payload.beat - 1];\n      gridItem.loopTriggers.push({\n        id: action.payload.loopId,\n        instanceId: action.payload.instanceId,\n      });\n\n      return {\n        ...state,\n        grid,\n      };\n    case TOGGLE_METRONOME:\n      return {\n        ...state,\n        metronome: !state.metronome,\n      };\n    case TOGGLE_PLAY:\n      return {\n        ...state,\n        playing: !state.playing,\n      };\n    case SET_ACTIVE_LOOP:\n      return {\n        ...state,\n        activeLoop: action.payload.loopId,\n      };\n    case SET_GAIN:\n      return {\n        ...state,\n        gain: action.payload.gain,\n      };\n    case SET_LOOP_LENGTH:\n      return {\n        ...state,\n        loopLength: action.payload.loopLength,\n      };\n    case SET_MIDI_DEVICES:\n      return {\n        ...state,\n        midiDeviceList: action.payload.devices,\n      };\n    case SET_INPUT_DEVICES:\n      return {\n        ...state,\n        inputDeviceList: action.payload.devices,\n      };\n    case SET_MEDIA_STREAM:\n      return {\n        ...state,\n        mediaStream: action.payload.stream,\n      };\n    case SET_TEMPO:\n      return {\n        ...state,\n        tempo: action.payload.tempo,\n      };\n    default:\n      return state;\n  }\n};\n","//\n// Middleware to convert midi events into redux actions\n//\n\nimport {\n  SET_MIDI_DEVICES,\n  toggleMetronome,\n  togglePlay,\n  setLoopLength,\n  TRIGGER_NOTE,\n  triggerNote,\n} from \"../actions/grid\";\n\nimport { recordMidiNote } from \"../actions/loop\";\n\nimport { getAudioCtx } from \"../audioUtils\";\nimport { HiHat, Snare, Kick, Clap, Cymbal } from \"../engines\";\n\n//\n// From Midi.js\n//\nconst KEY_TO_NOTE = {}; // C8  == 108\nconst NOTE_TO_KEY = {}; // 108 ==  C8\n\nconst A0 = 0x15; // first note\nconst C8 = 0x6c; // last note\nconst number2key = [\n  \"C\",\n  \"Db\",\n  \"D\",\n  \"Eb\",\n  \"E\",\n  \"F\",\n  \"Gb\",\n  \"G\",\n  \"Ab\",\n  \"A\",\n  \"Bb\",\n  \"B\",\n];\nfor (let n = A0; n <= C8; n++) {\n  const octave = ((n - 12) / 12) >> 0;\n  const name = number2key[n % 12] + octave;\n  KEY_TO_NOTE[name] = n;\n  NOTE_TO_KEY[n] = name;\n}\n\nconst NOTE_ON = 144;\n// const NOTE_OFF = 128;\n\nconst midiListener = (store) => (next) => {\n\n  // Listen to MIDI devices and dispatch actions when MIDI messages are received.\n  const listeningTo = [];\n  const listen = (devices, store) => {\n    for (const dev of devices) {\n      if (listeningTo.indexOf(dev.id) === -1) {\n        dev.addEventListener(\"midimessage\", (msg) => {\n          const [cmd, note, velocity] = msg.data;\n          const ctx = getAudioCtx();\n          if (cmd === NOTE_ON && velocity > 0) {\n            store.dispatch(triggerNote(NOTE_TO_KEY[note], velocity, ctx.currentTime));\n          }\n        });\n        listeningTo.push(dev.id);\n      }\n    }\n  };\n\n  return (action) => {\n    next(action);\n\n    if (action.type === SET_MIDI_DEVICES) {\n      listen(action.payload.devices, store);\n    }\n\n    if (action.type === TRIGGER_NOTE) {\n      // TODO:\n      //\n      //  - toggle input mode:\n      //    > instrument (keyboard / sample pad)\n      //    > controller (start / stop / record / multiply / undo)\n      //\n      //  This allows us to start lighting up keys on the sample pad etc based on mode\n      //\n      // const ctx = getAudioCtx();\n      const { note, triggerTime } = action.payload;\n\n      const { loopLength, recordingMidi } = store.getState().grid;\n      // const time = ctx.currentTime;\n      //\n      // const kick = new Kick(ctx);\n      // const hihat = new HiHat(ctx);\n      // const snare = new Snare(ctx);\n      // const clap = new Clap(ctx);\n      // const cymbal = new Cymbal(ctx);\n\n      const schedule = (engine) => {\n        if (recordingMidi) {\n          return recordMidiNote(engine, triggerTime)\n        }\n      };\n\n      // TODO:\n      //\n      //  - make this configurable in the app\n      //  - show current mapping in UI\n      //\n      //  Mapping for what each key does:\n      const NOTE_MAPPING = {\n        // Loop / playback commands\n        C1: () => togglePlay(),\n        D1: () => toggleMetronome(),\n\n        E1: () => setLoopLength(loopLength / 2),\n        F1: () => setLoopLength(loopLength * 2),\n\n        // Drum samples\n        C2: () => schedule(Kick),\n        Db2: () => schedule(HiHat),\n        D2: () => schedule(Snare),\n        Eb2: () => schedule(Cymbal),\n        E2: () => schedule(Clap),\n      };\n\n      const newAction = NOTE_MAPPING[note];\n      console.log(newAction);\n      if (newAction) {\n        const actionResult = newAction();\n        if (actionResult) {\n          store.dispatch(actionResult);\n        }\n      } else {\n        console.log(`Unmapped midi note ${note}`);\n      }\n    }\n  };\n};\n\nexport default midiListener;\n","import { combineReducers } from \"redux\";\nimport loopReducer from \"./loopReducer\";\nimport gridReducer from \"./gridReducer\";\n\nexport default combineReducers({\n  loop: loopReducer,\n  grid: gridReducer,\n});\n","//\n// Middleware that handles scheduling all the active loops to play at the correct times. It\n// reacts to changes in the redux state while maintaining a consistent beat.\n//\n\nimport { TOGGLE_PLAY } from \"../actions/grid\";\nimport { createLoop, setLoopStartTime } from \"../actions/loop\";\nimport { getMidiTracks} from \"../reducers/loopReducer\";\n\nimport { getAudioCtx, triggerMetronome, triggerMidi, triggerLoopsAtBeat, recordInputStream } from \"../audioUtils\";\n\nconst SCHEDULE_AHEAD_TIME = 0.1;\nconst TIMEOUT_DUR = 20;\n\nconst audioScheduler = (store) => (next) => {\n  let frame = null;\n  let nextNoteTime;\n  let nextBeat;\n\n  const loop = () => {\n    const audioCtx = getAudioCtx();\n    const state = store.getState();\n    const {\n      mediaStream,\n\n      quantizationMidi,\n\n      playing,\n      metronome,\n      tempo,\n      grid,\n      gain,\n      beats,\n      beatsPerBar,\n      loopLength,\n    } = state.grid;\n    const { loops, loopDuration, loopStartTime } = state.loop;\n    const secondsPerBeat = 60.0 / tempo;\n\n    try {\n      const cTime = audioCtx.currentTime;\n\n      //\n      // Manage audio triggering using a look-ahead scheduler\n      //\n      if (playing && nextNoteTime < cTime + SCHEDULE_AHEAD_TIME) {\n        // Get notes at \"nextBeat\" and schedule them to play in the webAudio audioCtx\n        triggerLoopsAtBeat(\n          grid,\n          loops,\n          nextBeat,\n          beats,\n          audioCtx,\n          gain,\n          nextNoteTime\n        );\n\n        triggerMidi(\n          getMidiTracks(),\n          beats,\n          secondsPerBeat,\n          quantizationMidi,\n          nextBeat,\n          nextNoteTime,\n          loopDuration,\n          loopStartTime\n        );\n\n        // At this point, we lock in the current state in redux as what audio will be scheduled\n        // regardless of user changes.\n        if (nextBeat % loopLength === 0) {\n          const loopStart = nextNoteTime;\n          const loopEnd = nextNoteTime + loopLength * secondsPerBeat;\n\n          // Start recording the next loop\n          recordInputStream(\n            mediaStream,\n            audioCtx,\n            loopStart,\n            loopEnd\n          ).then((d) => store.dispatch(createLoop(d)));\n        }\n\n        // Trigger metronome on each beat\n        if (metronome) {\n          triggerMetronome(\n            audioCtx,\n            nextBeat,\n            nextNoteTime,\n            beats,\n            beatsPerBar\n          );\n        }\n\n        nextBeat += 1;\n        nextBeat %= beats;\n        // Set the next target to schedule for\n        nextNoteTime += secondsPerBeat;\n      }\n    } finally {\n      frame = setTimeout(loop, TIMEOUT_DUR);\n    }\n  };\n\n  return (action) => {\n    // We need to track 2 versions of the state:\n    //\n    // 1. UI state (immediately updated on each user action)\n    // 2. Audio state (updated at the start of each quantization loop)\n\n    next(action);\n    const state = store.getState();\n    const {\n      tempo,\n      loopLength,\n    } = state.grid;\n    const secondsPerBeat = 60.0 / tempo;\n    const loopDuration = secondsPerBeat * loopLength;\n\n    // If the playing state has been toggled, start or stop the Raf loop\n    if (action.type === TOGGLE_PLAY && store.getState().grid.playing) {\n      const audioCtx = window.audioCtx || new AudioContext();\n      window.audioCtx = audioCtx;\n\n      nextBeat = 0;\n      nextNoteTime = audioCtx.currentTime + SCHEDULE_AHEAD_TIME;\n      store.dispatch(setLoopStartTime(nextNoteTime, loopDuration));\n      frame = setTimeout(loop, TIMEOUT_DUR);\n    } else if (action.type === TOGGLE_PLAY && frame) {\n      clearTimeout(frame);\n      nextBeat = 0;\n    }\n  };\n};\n\nexport default audioScheduler;\n","//\n// Middleware that manages DOM updates of the grid & loop cursors based on the beat. We avoid\n// using React's reconciler for this as it schedules updates for a later point when we want\n// to prioritise frame-level precision of which grid square is lit up\n//\n\nimport { TOGGLE_PLAY } from \"../actions/grid\";\nimport { getAudioCtx } from \"../audioUtils\";\n\nconst SCHEDULE_AHEAD_TIME = 0.1;\nconst ANIMATION_TOLERANCE = -0.05;\n\nconst visualScheduler = (store) => (next) => {\n  let frame = null;\n\n  let nextGridChangeTime;\n  let nextGridBeat;\n\n  const loop = () => {\n    const audioCtx = getAudioCtx();\n    const state = store.getState();\n    const { playing, tempo, beats } = state.grid;\n    const secondsPerBeat = 60.0 / tempo;\n\n    try {\n      const cTime = audioCtx.currentTime;\n\n      //\n      // Manage visual animations in real-time\n      //\n      if (playing && nextGridChangeTime < cTime + ANIMATION_TOLERANCE) {\n        let prevBeat = nextGridBeat - 1;\n        if (prevBeat === -1) {\n          prevBeat = beats - 1;\n        }\n\n        window.gridElems[prevBeat].classList.remove(\"active\");\n        window.gridElems[nextGridBeat].classList.add(\"active\");\n\n        nextGridBeat += 1;\n        nextGridBeat %= beats;\n        nextGridChangeTime += secondsPerBeat;\n      }\n    } finally {\n      // TODO Take into account that multiple beats can be missed before the loop will resume\n      //      as the audio scheduler will continue and we need to stay in sync with it\n      frame = requestAnimationFrame(loop);\n    }\n  };\n\n  return (action) => {\n    // We need to track 2 versions of the state:\n    //\n    // 1. UI state (immediately updated on each user action)\n    // 2. Audio state (updated at the start of each quantization loop)\n\n    next(action);\n\n    // If the playing state has been toggled, start or stop the Raf loop\n    if (action.type === TOGGLE_PLAY && store.getState().grid.playing) {\n      const audioCtx = window.audioCtx || new AudioContext();\n      window.audioCtx = audioCtx;\n\n      nextGridBeat = 0;\n      nextGridChangeTime = audioCtx.currentTime + SCHEDULE_AHEAD_TIME;\n      frame = requestAnimationFrame(loop);\n    } else if (action.type === TOGGLE_PLAY && frame) {\n      window.gridElems.forEach((elem) => elem.classList.remove(\"active\"));\n      cancelAnimationFrame(frame);\n    }\n  };\n};\n\nexport default visualScheduler;\n","export class Kick {\n    constructor(ctx) {\n        this.ctx = ctx;\n        this.tone = 167.1;\n        this.decay = 0.5;\n        this.volume = 1;\n        this.fxAmount = 0;\n    }\n\n    makeDistortionCurve(amount) {\n        var k = amount /4,\n            n_samples = 44100,\n            curve = new Float32Array(n_samples),\n            deg = Math.PI / 180,\n            i = 0,\n            x;\n        for (; i < n_samples; ++i) {\n            x = i * 2 / n_samples - 1;\n            curve[i] = (3 + k) * x * 20 * deg / (Math.PI + k * Math.abs(x));\n        }\n        return curve;\n    };\n\n    setup() {\n        this.osc = this.ctx.createOscillator();\n        this.osc.type = 'sine'\n        this.gain = this.ctx.createGain();\n        this.distortion = this.ctx.createWaveShaper();\n        this.distortion.curve = this.makeDistortionCurve(this.fxAmount);\n\n        this.osc.connect(this.gain);\n        this.gain.connect(this.distortion);\n        this.distortion.connect(this.ctx.destination);\n    }\n\n    trigger(time) {\n        if (this.volume === 0) { return };\n        this.setup();\n\n        this.osc.frequency.setValueAtTime(this.tone, time + 0.001);\n        this.gain.gain.linearRampToValueAtTime(this.volume, time + 0.1)\n\n        this.osc.frequency.exponentialRampToValueAtTime(1, time + this.decay);\n        this.gain.gain.exponentialRampToValueAtTime(0.01 * this.volume, time + this.decay);\n        this.gain.gain.linearRampToValueAtTime(0, time + this.decay + 0.1)\n\n        this.osc.start(time);\n        this.osc.stop(time + this.decay + 0.1);\n    }\n\n    setTone = (tone) => {\n        this.tone = tone;\n    }\n\n    setVolume = (vol) => {\n        this.volume = vol;\n    }\n\n    setFXAmount = (amount) => {\n        this.fxAmount = amount;\n    }\n}\n","export class Snare {\n    constructor(ctx) {\n        this.ctx = ctx;\n        this.tone = 100;\n        this.decay = 0.2;\n        this.volume = 1;\n    }\n\n    setup() {\n        this.noise = this.ctx.createBufferSource();\n        this.noise.buffer = this.noiseBuffer();\n\n        var noiseFilter = this.ctx.createBiquadFilter();\n        noiseFilter.type = 'highpass';\n        noiseFilter.frequency.value = 1000;\n        this.noise.connect(noiseFilter);\n\n        this.noiseEnvelope = this.ctx.createGain();\n        noiseFilter.connect(this.noiseEnvelope);\n\n        this.noiseEnvelope.connect(this.ctx.destination);\n\n        this.osc = this.ctx.createOscillator();\n        this.osc.type = 'triangle';\n\n        this.oscEnvelope = this.ctx.createGain();\n        this.osc.connect(this.oscEnvelope);\n        this.oscEnvelope.connect(this.ctx.destination);\n    }\n\n    noiseBuffer() {\n        var bufferSize = this.ctx.sampleRate;\n        var buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);\n        var output = buffer.getChannelData(0);\n\n        for (var i = 0; i < bufferSize; i++) {\n            output[i] = Math.random() * 2 - 1;\n        }\n\n        return buffer;\n    }\n\n    trigger(time) {\n        if (this.volume === 0) { return };\n        this.setup();\n\n        this.noiseEnvelope.gain.setValueAtTime(this.volume, time);\n        this.noiseEnvelope.gain.exponentialRampToValueAtTime(0.01, time + this.decay);\n\n        this.osc.frequency.setValueAtTime(this.tone, time);\n        this.oscEnvelope.gain.setValueAtTime(0.7 * this.volume, time);\n        this.oscEnvelope.gain.exponentialRampToValueAtTime(0.01 * this.volume, time + this.decay / 2);\n\n        this.osc.start(time);\n        this.noise.start(time);\n        this.osc.stop(time + this.decay);\n        this.noise.stop(time + this.decay);\n    }\n\n    setTone = (tone) => {\n        this.tone = tone;\n    }\n    setVolume = (vol) => {\n        this.volume = vol;\n    }\n    setFXAmount = (amount) => {\n        this.fxAmount = amount;\n    }\n}\n","export class HiHat {\n    constructor(ctx) {\n        this.ctx = ctx;\n        this.ratios = [1, 1.3420, 1.2312, 1.6532, 1.9523, 2.1523];\n        this.tone = 130.81;\n        this.decay = 0.5;\n        this.volume = 1;\n        this.fxAmount = 0;\n    }\n\n    setup() {\n        this.oscEnvelope = this.ctx.createGain();\n        this.bndPass = this.ctx.createBiquadFilter();\n        this.bndPass.type = 'bandpass';\n        this.bndPass.frequency.value = 20000;\n        this.bndPass.Q.value = 0.2;\n        this.hipass = this.ctx.createBiquadFilter();\n        this.hipass.type = \"highpass\";\n        this.hipass.frequency.value = 5000;\n        this.panner = this.ctx.createStereoPanner();\n\n        this.bndPass.connect(this.hipass);\n        this.hipass.connect(this.oscEnvelope);\n        this.oscEnvelope.connect(this.panner);\n        this.panner.connect(this.ctx.destination);\n    }\n\n    trigger(time) {\n        if (this.volume === 0) { return };\n        this.setup();\n\n        this.panner.pan.value = Math.cos(time * 4) * this.fxAmount/100;\n        this.ratios.forEach((ratio) => {\n            var osc = this.ctx.createOscillator();\n            osc.type = \"square\";\n            osc.frequency.value = this.tone * ratio;\n            osc.connect(this.bndPass);\n            osc.start(time);\n            osc.stop(time + this.decay);\n        });\n        this.oscEnvelope.gain.setValueAtTime(0.00001 * this.volume, time);\n        this.oscEnvelope.gain.exponentialRampToValueAtTime(1 * this.volume, time + 0.067 * this.decay);\n        this.oscEnvelope.gain.exponentialRampToValueAtTime(0.3 * this.volume, time + 0.1 * this.decay);\n        this.oscEnvelope.gain.exponentialRampToValueAtTime(0.00001 * this.volume, time + this.decay);\n    }\n\n    setTone = (tone) => {\n        this.tone = tone;\n    }\n    setVolume = (vol) => {\n        this.volume = vol;\n    }\n\n    setFXAmount = (amount) => {\n        this.fxAmount = amount;\n    }\n}\n","export class Clap {\n\n    constructor(ctx) {\n        this.tone = 130;\n        this.volume = 1;\n        this.decay = 0.3;\n        this.pulseWidth = 0.025;\n        this.ctx = ctx;\n        this.fxAmount = 0;\n    }\n\n    noiseBuffer() {\n        var bufferSize = this.ctx.sampleRate;\n        var buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);\n        var output = buffer.getChannelData(0);\n\n        for (var i = 0; i < bufferSize; i++) {\n            output[i] = Math.random() * 2 - 1;\n        }\n        return buffer;\n    }\n\n    setup() {\n        this.noise = this.ctx.createBufferSource();\n        this.noise.buffer = this.noiseBuffer();\n        this.filter = this.ctx.createBiquadFilter();\n        this.filter.type = 'bandpass';\n        this.filter.frequency.value = this.tone * 2;\n        this.envelope = this.ctx.createGain();\n        this.feedback = this.ctx.createGain();\n        this.echo = this.ctx.createDelay();\n        // this.echo.delayTime.value = Time('6n').toSeconds() // TODO\n        this.feedback.gain.value = 0.99 * this.fxAmount/100;\n\n        this.noise.connect(this.filter);\n        this.filter.connect(this.envelope);\n        \n        this.envelope.connect(this.echo);\n        this.echo.connect(this.feedback);\n        this.feedback.connect(this.echo);\n        this.feedback.connect(this.ctx.destination);\n        this.envelope.connect(this.ctx.destination);\n    }\n\n    trigger = (time) => {\n        if (this.volume === 0) { return };\n        this.setup();\n\n        this.envelope.gain.setValueAtTime(this.volume, time);\n        this.envelope.gain.exponentialRampToValueAtTime(0.1, time + this.pulseWidth);\n\n        this.envelope.gain.setValueAtTime(this.volume, time + this.pulseWidth);\n        this.envelope.gain.exponentialRampToValueAtTime(0.1, time + 2 * this.pulseWidth);\n\n        this.envelope.gain.setValueAtTime(this.volume, time + 2 * this.pulseWidth);\n        this.envelope.gain.exponentialRampToValueAtTime(0.001, time + this.decay);\n\n        this.noise.start(time)\n        this.noise.stop(time + this.decay);\n    }\n\n    setTone = (tone) => {\n        this.tone = tone;\n    }\n\n    setVolume = (volume) => {\n        this.volume = volume;\n    }\n\n    setFXAmount = (amount) => {\n        this.fxAmount = amount;\n    }\n}\n","export class Cymbal {\n    constructor(ctx) {\n        this.ctx = ctx;\n        this.ratios = [1, 1.3420, 1.2312, 1.6532, 1.9523, 2.1523];\n        this.tone = 130.81;\n        this.decay = 1.5;\n        this.volume = 1;\n        this.fxAmount = 0;\n    }\n\n    async setup() {\n        this.noise = this.ctx.createBufferSource();\n        this.noise.buffer = this.noiseBuffer();\n        this.noiseEnvelope = this.ctx.createGain();\n        this.noiseFilter = this.ctx.createBiquadFilter();\n        this.noiseFilter.type = 'highpass';\n        this.noiseFilter.frequency.value = 2000;\n        this.oscEnvelope = this.ctx.createGain();\n        this.bndPass = this.ctx.createBiquadFilter();\n        this.bndPass.type = 'bandpass';\n        this.bndPass.frequency.value = 20000;\n        this.bndPass.Q.value = 0.2;\n        this.hipass = this.ctx.createBiquadFilter();\n        this.hipass.type = \"highpass\";\n        this.hipass.frequency.value = 5000;\n        this.noise.connect(this.noiseFilter);\n        this.noiseFilter.connect(this.noiseEnvelope);\n\n        this.bndPass.connect(this.hipass);\n        this.hipass.connect(this.oscEnvelope);\n        this.noiseEnvelope.connect(this.ctx.destination);\n        this.oscEnvelope.connect(this.ctx.destination);\n    }\n\n    noiseBuffer() {\n        var bufferSize = this.ctx.sampleRate;\n        var buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);\n        var output = buffer.getChannelData(0);\n\n        for (var i = 0; i < bufferSize; i++) {\n            output[i] = Math.random() * 2 - 1;\n        }\n\n        return buffer;\n    }\n\n    trigger(time) {\n        if (this.volume === 0) { return };\n        this.setup();\n\n        this.ratios.forEach((ratio) => {\n            var osc = this.ctx.createOscillator();\n            osc.type = \"square\";\n            // Frequency is the fundamental * this oscillator's ratio\n            osc.frequency.value = this.tone * ratio;\n            osc.connect(this.bndPass);\n            osc.start(time);\n            osc.stop(time + this.decay);\n        });\n\n        this.oscEnvelope.gain.setValueAtTime(0.00001 * this.volume, time);\n        this.oscEnvelope.gain.exponentialRampToValueAtTime(1 * this.volume, time + 0.01);\n        this.oscEnvelope.gain.exponentialRampToValueAtTime(0.3 * this.volume, time + 0.1 * this.decay + this.fxAmount/100);\n        this.oscEnvelope.gain.exponentialRampToValueAtTime(0.00001 * this.volume, time + this.decay + this.fxAmount/50);\n    }\n\n    setTone = (tone) => {\n        this.tone = tone;\n    }\n    setVolume = (vol) => {\n        this.volume = vol;\n    }\n    setFXAmount = (amount) => {\n        this.fxAmount = parseFloat(amount);\n    }\n}\n","// This optional code is used to register a service worker.\n// register() is not called by default.\n\n// This lets the app load faster on subsequent visits in production, and gives\n// it offline capabilities. However, it also means that developers (and users)\n// will only see deployed updates on subsequent visits to a page, after all the\n// existing tabs open on the page have been closed, since previously cached\n// resources are updated in the background.\n\n// To learn more about the benefits of this model and instructions on how to\n// opt-in, read https://bit.ly/CRA-PWA\n\nconst isLocalhost = Boolean(\n  window.location.hostname === 'localhost' ||\n    // [::1] is the IPv6 localhost address.\n    window.location.hostname === '[::1]' ||\n    // 127.0.0.0/8 are considered localhost for IPv4.\n    window.location.hostname.match(\n      /^127(?:\\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/\n    )\n);\n\nexport function register(config) {\n  if (process.env.NODE_ENV === 'production' && 'serviceWorker' in navigator) {\n    // The URL constructor is available in all browsers that support SW.\n    const publicUrl = new URL(process.env.PUBLIC_URL, window.location.href);\n    if (publicUrl.origin !== window.location.origin) {\n      // Our service worker won't work if PUBLIC_URL is on a different origin\n      // from what our page is served on. This might happen if a CDN is used to\n      // serve assets; see https://github.com/facebook/create-react-app/issues/2374\n      return;\n    }\n\n    window.addEventListener('load', () => {\n      const swUrl = `${process.env.PUBLIC_URL}/service-worker.js`;\n\n      if (isLocalhost) {\n        // This is running on localhost. Let's check if a service worker still exists or not.\n        checkValidServiceWorker(swUrl, config);\n\n        // Add some additional logging to localhost, pointing developers to the\n        // service worker/PWA documentation.\n        navigator.serviceWorker.ready.then(() => {\n          console.log(\n            'This web app is being served cache-first by a service ' +\n              'worker. To learn more, visit https://bit.ly/CRA-PWA'\n          );\n        });\n      } else {\n        // Is not localhost. Just register service worker\n        registerValidSW(swUrl, config);\n      }\n    });\n  }\n}\n\nfunction registerValidSW(swUrl, config) {\n  navigator.serviceWorker\n    .register(swUrl)\n    .then(registration => {\n      registration.onupdatefound = () => {\n        const installingWorker = registration.installing;\n        if (installingWorker == null) {\n          return;\n        }\n        installingWorker.onstatechange = () => {\n          if (installingWorker.state === 'installed') {\n            if (navigator.serviceWorker.controller) {\n              // At this point, the updated precached content has been fetched,\n              // but the previous service worker will still serve the older\n              // content until all client tabs are closed.\n              console.log(\n                'New content is available and will be used when all ' +\n                  'tabs for this page are closed. See https://bit.ly/CRA-PWA.'\n              );\n\n              // Execute callback\n              if (config && config.onUpdate) {\n                config.onUpdate(registration);\n              }\n            } else {\n              // At this point, everything has been precached.\n              // It's the perfect time to display a\n              // \"Content is cached for offline use.\" message.\n              console.log('Content is cached for offline use.');\n\n              // Execute callback\n              if (config && config.onSuccess) {\n                config.onSuccess(registration);\n              }\n            }\n          }\n        };\n      };\n    })\n    .catch(error => {\n      console.error('Error during service worker registration:', error);\n    });\n}\n\nfunction checkValidServiceWorker(swUrl, config) {\n  // Check if the service worker can be found. If it can't reload the page.\n  fetch(swUrl, {\n    headers: { 'Service-Worker': 'script' },\n  })\n    .then(response => {\n      // Ensure service worker exists, and that we really are getting a JS file.\n      const contentType = response.headers.get('content-type');\n      if (\n        response.status === 404 ||\n        (contentType != null && contentType.indexOf('javascript') === -1)\n      ) {\n        // No service worker found. Probably a different app. Reload the page.\n        navigator.serviceWorker.ready.then(registration => {\n          registration.unregister().then(() => {\n            window.location.reload();\n          });\n        });\n      } else {\n        // Service worker found. Proceed as normal.\n        registerValidSW(swUrl, config);\n      }\n    })\n    .catch(() => {\n      console.log(\n        'No internet connection found. App is running in offline mode.'\n      );\n    });\n}\n\nexport function unregister() {\n  if ('serviceWorker' in navigator) {\n    navigator.serviceWorker.ready\n      .then(registration => {\n        registration.unregister();\n      })\n      .catch(error => {\n        console.error(error.message);\n      });\n  }\n}\n","import React from 'react';\nimport ReactDOM from 'react-dom';\nimport './index.css';\nimport App from './App';\n\nimport { Provider } from 'react-redux'\nimport configureStore from './store'\n\nimport * as serviceWorker from './serviceWorker';\n\nReactDOM.render(\n  <React.StrictMode>\n    <Provider store={configureStore()}>\n      <App />\n    </Provider>\n  </React.StrictMode>,\n  document.getElementById('root')\n);\n\n// If you want your app to work offline and load faster, you can change\n// unregister() to register() below. Note this comes with some pitfalls.\n// Learn more about service workers: https://bit.ly/CRA-PWA\nserviceWorker.unregister();\n","import { createStore, applyMiddleware } from \"redux\";\nimport rootReducer from \"./reducers/rootReducer\";\n\nimport audioScheduler from \"./middlewares/audioScheduler\";\nimport visualScheduler from \"./middlewares/visualScheduler\";\nimport midiListener from \"./middlewares/midiListener\";\n\nexport default function configureStore(initialState = {}) {\n  return createStore(\n    rootReducer,\n    initialState,\n    applyMiddleware(audioScheduler, visualScheduler, midiListener)\n  );\n}\n"],"sourceRoot":""}