(this.webpackJsonpknotted=this.webpackJsonpknotted||[]).push([[0],{34:function(e,t,n){e.exports=n(48)},39:function(e,t,n){},47:function(e,t,n){},48:function(e,t,n){"use strict";n.r(t);var a=n(0),r=n.n(a),o=n(15),i=n.n(o),c=(n(39),n(4)),u=n(5),l=n(50),d=n(31),s=n(51),p=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.buffer,n=void 0===t?null:t,o=e.width,i=void 0===o?500:o,c=e.height,u=void 0===c?100:c,l=e.zoom,d=void 0===l?1:l,s=e.color,p=void 0===s?"black":s,m=e.onDone,g=void 0===m?null:m,v=e.pixelRatio,b=void 0===v?window.devicePixelRatio:v,h=Object(a.useRef)(null);Object(a.useLayoutEffect)((function(){var e=h.current.getContext("2d"),t=i*d,a=u/2,r=n.getChannelData(0),o=Math.ceil(r.length/t);e.fillStyle=p,f(i,o,a,r,e),g&&g()}));var E=Math.floor(b*i*d),O=Math.floor(b*u),y={width:i*d,height:u};return r.a.createElement("canvas",{ref:h,width:E,height:O,style:y})};function f(e,t,n,a,r){for(var o=0;o<e;o+=1)for(var i=1,c=-1,u=0;u<t;u+=1){var l=a[o*t+u];l<i?i=l:l>c&&(c=l),r.fillRect(o,(1+i)*n,1,Math.max(1,(c-i)*n))}}var m=Object(a.memo)((function(e){return r.a.createElement(p,e)}),(function(e,t){return e.id===t.id&&e.width===t.width&&e.height===t.height&&e.color===t.color})),g=n(53),v=n(28),b=n.n(v),h=function(e){return{type:"@GRID/CREATE_LOOP",payload:{buffer:e,color:b()(),id:Object(g.a)()}}},E="@GRID/TOGGLE_PLAY",O=function(){return{type:E}},y=function(e){return{type:"@GRID/SET_LOOP_LENGTH",payload:{loopLength:e}}},I=function(e,t){return{type:"@GRID/TRIGGER_NOTE",payload:{note:e,velocity:t}}};function D(e){var t=e.id,n=e.index,a=(e.length,e.active),o=e.color,i=e.buffer,u=e.width,l=e.height,d=e.tempo,p=e.setActiveLoopA,f=60/d,g=Math.round(i.duration/f),v=Object(s.a)({item:{id:t,type:"LOOP"}}),b=Object(c.a)(v,2),h=b[0].opacity,E=b[1];return r.a.createElement("div",{ref:E,className:"Loop ".concat(a?"active":""),style:{opacity:h,height:l,width:u,paddingTop:20},onClick:function(){return p(t)}},r.a.createElement(m,{id:t,width:u,height:l-20,color:o,buffer:i}),r.a.createElement("div",null,"Loop ",n," ","//"," ",g," beats"))}var j=Object(u.b)((function(e){return{loops:e.loop.loops,activeLoop:e.grid.activeLoop,tempo:e.grid.tempo}}),(function(e){return{createLoopA:function(t){return e(h(t))},setActiveLoopA:function(t){return e(function(e){return{type:"@GRID/SET_ACTIVE_LOOP",payload:{loopId:e}}}(t))}}}))((function(e){var t=e.loops,n=e.width,a=e.tempo,o=e.activeLoop,i=(e.createLoopA,e.setActiveLoopA);return r.a.createElement("div",{className:"LoopPanel",style:{width:n}},t.map((function(e,t){return r.a.createElement(D,Object.assign({key:e.id,index:t,setActiveLoopA:i,active:o===e.id},e,{tempo:a,width:n-20,height:75}))})))})),A=n(2),w=n(52);function L(e){e.id;var t=e.color,n=e.soft,a=e.numMarkers,o=n?.3:1;return r.a.createElement("div",{className:"GridLoopMarker ".concat(a>4?"half":""),style:{backgroundColor:t,opacity:o}})}function T(e){var t=e.beat,n=(e.barBeat,e.loopTriggers),a=e.loopTails,o=(e.activeLoop,e.setGridElemA),i=e.addLoopInstanceA,c=e.onClick,u=Object(w.a)({accept:["LOOP"],drop:function(e){return i(t,e.id)}})[1],l=n.length+a.length;return r.a.createElement("div",{ref:function(e){o(t,e),u(e)},className:"Grid",onClick:c},n.map((function(e){return r.a.createElement(L,Object.assign({key:e.instanceId},e,{numMarkers:l}))})),a.map((function(e){return r.a.createElement(L,Object.assign({key:e.instanceId},e,{soft:!0,numMarkers:l}))})))}var G=Object(u.b)((function(e){var t=e.grid.tempo,n=e.grid.grid.map((function(n){return n.loopTriggers.map((function(a){var r=a.id,o=a.instanceId,i=e.loop.loops.find((function(e){return e.id===r})),c=60/t,u=Math.round(i.buffer.duration/c),l=[n.beat,(n.beat+u-1)%e.grid.grid.length];return Object(A.a)({range:l,instanceId:o},i)}))})).flat(),a=e.grid.grid.map((function(e){var t=n.filter((function(t){return t.range[0]===e.beat})),a=n.filter((function(t){return n=t.range[0]+1,a=t.range[1],(r=e.beat)>=n&&r<=a||t.range[0]>t.range[1]&&e.beat>t.range[0]||t.range[0]>t.range[1]&&e.beat<t.range[1];var n,a,r}));return Object(A.a)(Object(A.a)({},e),{},{loopTriggers:t,loopTails:a})}));return Object(A.a)(Object(A.a)({},e.grid),{},{grid:a})}),(function(e){return{setGridElemA:function(t,n){return e(function(e,t){return{type:"@GRID/SET_GRID_ELEM",payload:{index:e,domElem:t}}}(t,n))},addLoopInstanceA:function(t,n){return e(function(e,t){return{type:"@GRID/ADD_LOOP_INSTANCE",payload:{beat:e,loopId:t,instanceId:Object(g.a)()}}}(t,n))}}}))((function(e){var t=e.activeLoop,n=e.width,a=e.grid,o=(e.beats,e.beatsPerBar,e.setGridElemA),i=e.addLoopInstanceA;return r.a.createElement("div",{className:"GridPanel",style:{width:n,height:n}},a.map((function(e){return r.a.createElement(T,Object.assign({key:e.beat},e,{setGridElemA:o,addLoopInstanceA:i,onClick:function(){return t&&i(e.beat,t)}}))})))})),R=n(7),S=n.n(R),M=n(24),_=n.n(M),C=n(29),k=100,x=null;function N(){return x||(x=new AudioContext({latencyHint:0}))}function P(e,t,n){var a,r=new MediaRecorder(e);return r.start(1e3*n),new Promise((function(e){return r.ondataavailable=function(n){a=t.currentTime,"recording"===r.state&&r.stop(),e(n.data)}})).then((function(e){return e.arrayBuffer()})).then((function(e){return new Promise((function(n,r){return t.decodeAudioData(e,(function(e){return n([e,a])}),r)}))}))}function B(e){return e.reduce((function(e,t){return e+Math.abs(t)}),0)}function F(){return(F=Object(C.a)(_.a.mark((function e(t){var n,a,r,o,i,u,l,d,s,p,f,m,g,v,b,h,E;return _.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=N(),(a=n.createOscillator()).frequency.value=440,a.connect(n.destination),r=n.currentTime,o=P(t,n,4),a.start(r+2),a.stop(r+3),e.next=10,o;case 10:i=e.sent,u=Object(c.a)(i,2),l=u[0],d=u[1],s=l.getChannelData(0),p=l.sampleRate,f=1e3*(d-4),m=s.slice(0,p),g=B(m)/p,v=20*Math.log10(g)+24,b=Math.pow(10,v/20),h=null,E=p;case 23:if(!(E<4*p)){e.next=30;break}if(!(s[E]>Math.abs(b))){e.next=27;break}return h=Math.round(Math.abs(2e3-1e3*E/p)),e.abrupt("break",30);case 27:E++,e.next=23;break;case 30:return console.log(f),console.log(h),k=h,e.abrupt("return",h);case 34:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var U=Object(u.b)((function(e){return{playing:e.grid.playing,tempo:e.grid.tempo,metronome:e.grid.metronome,gain:e.grid.gain,loopLength:e.grid.loopLength,mediaStream:e.grid.mediaStream,inputDeviceList:e.grid.inputDeviceList,midiDeviceList:e.grid.midiDeviceList,activeInputDevice:e.grid.activeInputDevice}}),(function(e){return{togglePlayA:function(){return e(O())},toggleMetronomeA:function(){return e({type:"@GRID/TOGGLE_METRONOME"})},setTempoA:function(t){return e(function(e){return{type:"@GRID/SET_TEMPO",payload:{tempo:e}}}(t))},setGainA:function(t){return e(function(e){return{type:"@GRID/SET_GAIN",payload:{gain:e}}}(t))},setInputDevicesA:function(t){return e(function(e){return{type:"@GRID/SET_INPUT_DEVICES",payload:{devices:e}}}(t))},setMidiDevicesA:function(t){return e(function(e){return{type:"@GRID/SET_MIDI_DEVICES",payload:{devices:e}}}(t))},setMediaStreamA:function(t){return e(function(e){return{type:"@GRID/SET_MEDIA_STREAM",payload:{stream:e}}}(t))},setLoopLengthA:function(t){return e(y(t))}}}))((function(e){e.playing;var t=e.loopLength,n=e.gain,o=e.width,i=e.tempo,c=e.metronome,u=e.mediaStream,l=e.midiDeviceList,d=e.activeInputDevice,s=e.inputDeviceList,p=(e.togglePlayA,e.setGainA),f=e.setTempoA,m=e.toggleMetronomeA,g=e.setInputDevicesA,v=e.setMidiDevicesA,b=e.setMediaStreamA,h=e.setLoopLengthA;Object(a.useEffect)((function(){var e;(e=d,navigator.mediaDevices.getUserMedia({audio:{AUDIO_CONFIG:{echoCancellation:!1,noiseSuppression:!1,autoGainControl:!1,latency:0},deviceId:e}})).then((function(e){return b(e)}))}),[b,d]),Object(a.useEffect)((function(){function e(e){for(var t=[],n=e.inputs.values(),a=n.next();a&&!a.done;a=n.next())t.push(a.value);v(t)}navigator.requestMIDIAccess().then((function(t){t.addEventListener("statechange",(function(t){return e(t.target)})),e(t)}),(function(e){return console.log("Something went wrong",e)}))}),[v]),Object(a.useEffect)((function(){u&&navigator.mediaDevices.enumerateDevices().then((function(e){return g(e)}))}),[u,g]);var E=s.reduce((function(e,t){return"audioinput"===t.kind&&(e[t.label]=t.deviceId),e}),{}),O=l.reduce((function(e,t){return"input"===t.type&&(e[t.name]=t.id),e}),{});return r.a.createElement(S.a,{theme:"light",width:.6*o,onChange:function(e,t){"tempo"===e&&f(t),"metronome"===e&&m(),"gain"===e&&p(t),"latency"===e&&function(e){F.apply(this,arguments)}(u),"loop length"===e&&12!==t&&h(t)},state:{latency:!1,tempo:i,gain:n,metronome:c,"loop length":t}},r.a.createElement(R.Range,{label:"loop length",min:4,max:16,step:4}),r.a.createElement(R.Range,{label:"tempo",min:40,max:260,step:1}),r.a.createElement(R.Range,{label:"gain",min:0,max:1}),r.a.createElement(R.Checkbox,{label:"metronome"}),r.a.createElement(R.Select,{label:"input",options:E}),r.a.createElement(R.Select,{label:"inputmidi",options:O}),r.a.createElement(R.Checkbox,{label:"latency"}))}));n(47);var q=Object(u.b)((function(e){return{playing:e.grid.playing}}),(function(e){return{togglePlayA:function(){return e(O())}}}))((function(e){var t=e.playing,n=e.togglePlayA,o=function(){var e="object"===typeof window,t=Object(a.useCallback)((function(){return{width:e?window.innerWidth:void 0,height:e?window.innerHeight:void 0}}),[e]),n=Object(a.useState)(t),r=Object(c.a)(n,2),o=r[0],i=r[1];return Object(a.useEffect)((function(){if(!e)return!1;function n(){i(t())}return window.addEventListener("resize",n),function(){return window.removeEventListener("resize",n)}}),[t,e]),o}(),i=o.width,u=o.height,s=Math.min(.75*i,u-120),p=t?"pause":"";return r.a.createElement("div",{className:"Wrapper"},r.a.createElement("header",{className:"Controls"},r.a.createElement("button",{className:"PlayButton ".concat(p),onClick:n}),r.a.createElement(U,{width:i})),r.a.createElement("div",{className:"App"},r.a.createElement(l.a,{backend:d.a},r.a.createElement(G,{width:s,activeBeat:0}),r.a.createElement(j,{width:i-s}))),r.a.createElement("footer",null,"By ",r.a.createElement("a",{href:"https://jtfell.com"},"jtfell")))})),V=n(6),z=n(9),H={loops:[],loopsInUse:[]};window.gridElems=[];var W,J,Y={beatsPerBar:4,beats:16,playing:!1,metronome:!0,tempo:136.55,loopLength:8,quantizationBeats:4,gain:.2,activeLoop:null,activeMidiDevice:null,midiDeviceList:[],activeInputDevice:null,inputDeviceList:[],mediaStream:null,grid:(W=16,J=4,Object(z.a)(Array(W).keys()).map((function(e){return{beat:e+1,barBeat:(e+1)%J,loopTriggers:[]}})))};for(var $=Object(V.c)({loop:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:H,t=arguments.length>1?arguments[1]:void 0;switch(t.type){case"@GRID/CREATE_LOOP":var n=Object(z.a)(e.loops),a=Date.now();if(n.length<3)return n=[].concat(Object(z.a)(n),[Object(A.a)(Object(A.a)({},t.payload),{},{createdAt:a})]),Object(A.a)(Object(A.a)({},e),{},{loops:n});var r=n.reduce((function(t,n,a){var r=Object(c.a)(t,2),o=r[0],i=r[1];return e.loopsInUse.indexOf(n.id)>-1?[o,i]:null===o||o.createdAt>n.createdAt?[n,a]:[o,i]}),[null,-1]),o=Object(c.a)(r,2),i=(o[0],o[1]);return i>-1?n[i]=Object(A.a)(Object(A.a)({},t.payload),{},{createdAt:a}):console.log("No space!"),Object(A.a)(Object(A.a)({},e),{},{loops:n});case"@GRID/ADD_LOOP_INSTANCE":return Object(A.a)(Object(A.a)({},e),{},{loopsInUse:[].concat(Object(z.a)(e.loopsInUse),[t.payload.loopId])});default:return e}},grid:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Y,t=arguments.length>1?arguments[1]:void 0;switch(t.type){case"@GRID/SET_GRID_ELEM":return window.gridElems[t.payload.index-1]=t.payload.domElem,e;case"@GRID/ADD_LOOP_INSTANCE":var n=Object(z.a)(e.grid),a=n[t.payload.beat-1];return a.loopTriggers.push({id:t.payload.loopId,instanceId:t.payload.instanceId}),Object(A.a)(Object(A.a)({},e),{},{grid:n});case"@GRID/TOGGLE_METRONOME":return Object(A.a)(Object(A.a)({},e),{},{metronome:!e.metronome});case E:return Object(A.a)(Object(A.a)({},e),{},{playing:!e.playing});case"@GRID/SET_ACTIVE_LOOP":return Object(A.a)(Object(A.a)({},e),{},{activeLoop:t.payload.loopId});case"@GRID/SET_GAIN":return Object(A.a)(Object(A.a)({},e),{},{gain:t.payload.gain});case"@GRID/SET_LOOP_LENGTH":return Object(A.a)(Object(A.a)({},e),{},{loopLength:t.payload.loopLength});case"@GRID/SET_MIDI_DEVICES":return Object(A.a)(Object(A.a)({},e),{},{midiDeviceList:t.payload.devices});case"@GRID/SET_INPUT_DEVICES":return Object(A.a)(Object(A.a)({},e),{},{inputDeviceList:t.payload.devices});case"@GRID/SET_MEDIA_STREAM":return Object(A.a)(Object(A.a)({},e),{},{mediaStream:t.payload.stream});case"@GRID/SET_TEMPO":return Object(A.a)(Object(A.a)({},e),{},{tempo:t.payload.tempo});default:return e}}}),K=function(e){return function(t){var n,a,r=null,o=function t(){var o=N(),i=e.getState(),u=i.grid,l=u.mediaStream,d=u.playing,s=u.metronome,p=u.tempo,f=u.grid,m=u.gain,g=u.beats,v=u.beatsPerBar,b=u.loopLength,E=i.loop.loops,O=60/p;try{var y=o.currentTime;if(d&&n<y+.1){if(function(e,t,n,a,r,o,i){e[n%a].loopTriggers.map((function(e){var n=e.id;return t.find((function(e){return e.id===n}))})).forEach((function(e){var t=e.buffer,n=r.createBufferSource();n.buffer=t;var a=r.createGain();a.gain.setValueAtTime(o,r.currentTime),n.connect(a).connect(r.destination),n.start(i)}))}(f,E,a,g,o,m,n),a%b===0){var I=n,D=n+b*O;console.log("New loop - ".concat(I," / ").concat(D)),function(e,t,n,a){var r=a-t.currentTime;return P(e,t,r+.2).then((function(e){for(var r=Object(c.a)(e,2),o=r[0],i=(r[1],o.sampleRate),u=t.createBuffer(1,(a-n)*i,i),l=u.getChannelData(0),d=o.getChannelData(0),s=0;s<(a-n)*i;s++)l[s]=d[s+Math.floor(k*i/1e3)];return u}))}(l,o,I,D).then((function(t){return e.dispatch(h(t))}))}s&&function(e,t,n,a,r){var o=e.createOscillator();o.connect(e.destination),o.frequency.value=t%a===0?880:t%r===0?440:220,o.start(n),o.stop(n+.01)}(o,a,n,g,v),a+=1,a%=g,n+=O}}finally{r=requestAnimationFrame(t)}};return function(i){if(t(i),i.type===E&&e.getState().grid.playing){var c=window.audioCtx||new AudioContext;window.audioCtx=c,a=0,n=c.currentTime+.1,r=requestAnimationFrame(o)}else i.type===E&&r&&cancelAnimationFrame(r)}}},Q=function(e){return function(t){var n,a,r=null,o=function t(){var o=N(),i=e.getState().grid,c=i.playing,u=i.tempo,l=i.beats,d=60/u;try{var s=o.currentTime;if(c&&n<s+-.05){var p=a-1;-1===p&&(p=l-1),window.gridElems[p].classList.remove("active"),window.gridElems[a].classList.add("active"),a+=1,a%=l,n+=d}}finally{r=requestAnimationFrame(t)}};return function(i){if(t(i),i.type===E&&e.getState().grid.playing){var c=window.audioCtx||new AudioContext;window.audioCtx=c,a=0,n=c.currentTime+.1,r=requestAnimationFrame(o)}else i.type===E&&r&&(window.gridElems.forEach((function(e){return e.classList.remove("active")})),cancelAnimationFrame(r))}}},X=n(30),Z={},ee={},te=["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"],ne=21;ne<=108;ne++){var ae=te[ne%12]+((ne-12)/12>>0);Z[ae]=ne,ee[ne]=ae}var re=function(e){return function(t){var n=[];return function(a){if(t(a),"@GRID/SET_MIDI_DEVICES"===a.type&&function(e,t){var a,r=Object(X.a)(e);try{for(r.s();!(a=r.n()).done;){var o=a.value;-1===n.indexOf(o.id)&&(o.addEventListener("midimessage",(function(e){var n=Object(c.a)(e.data,3),a=n[0],r=n[1],o=n[2];144===a&&o>0&&t.dispatch(I(ee[r],o))})),n.push(o.id))}}catch(i){r.e(i)}finally{r.f()}}(a.payload.devices,e),"@GRID/TRIGGER_NOTE"===a.type){var r=a.payload.note,o=e.getState().grid.loopLength,i={C1:function(){return O()},D1:function(){return{type:"@GRID/TOGGLE_METRONOME"}},E1:function(){return y(o-4)},F1:function(){return y(o+4)}}[r];i?e.dispatch(i()):console.log("Unmapped midi note ".concat(r))}}}};Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));i.a.render(r.a.createElement(r.a.StrictMode,null,r.a.createElement(u.a,{store:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return Object(V.d)($,e,Object(V.a)(K,Q,re))}()},r.a.createElement(q,null))),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then((function(e){e.unregister()})).catch((function(e){console.error(e.message)}))}},[[34,1,2]]]);
//# sourceMappingURL=main.de02f4d4.chunk.js.map